var H=Object.defineProperty,K=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var W=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var z=(o,e,d)=>e in o?H(o,e,{enumerable:!0,configurable:!0,writable:!0,value:d}):o[e]=d,A=(o,e)=>{for(var d in e||(e={}))W.call(e,d)&&z(o,d,e[d]);if(M)for(var d of M(e))X.call(e,d)&&z(o,d,e[d]);return o},L=(o,e)=>K(o,Q(e));import{m as D}from"./api.16541527135635.js";import{P as Y}from"./ProjectEnvSelect.1654152713563.js";import{i as U,a as R,b as Z}from"./assert.1654152713563.js";import{f as x,a as G}from"./format.1654152713563.js";import{_ as ee,A as ae,q as oe,r as le,t as te,b as u,d as r,e as _,h as c,g as t,w as n,F as B,j as k,k as y,i as w,z as ne,E as C,B as v}from"./index.1654152713563.js";import"./Api.1654152713563.js";import"./api.16541527135633.js";const se=ae({name:"MongoDataOp",components:{ProjectEnvSelect:Y},setup(){const o=oe(null),e=le({loading:!1,mongoList:[],query:{envId:0},mongoId:null,database:"",collection:"",activeName:"",databases:[],collections:[],dataTabs:{},findDialog:{visible:!1,findParam:{filter:"",sort:""}},insertDocDialog:{visible:!1,doc:""}}),d=async()=>{Z(e.query.envId,"\u8BF7\u5148\u9009\u62E9\u9879\u76EE\u73AF\u5883");const l=await D.mongoList.request(e.query);e.mongoList=l.list},$=(l,s)=>{e.databases=[],e.collections=[],e.mongoId=null,e.collection="",e.database="",e.dataTabs={},s!=null&&(e.query.envId=s,d())},q=()=>{e.databases=[],e.collections=[],e.dataTabs={},J()},J=async()=>{const l=await D.databases.request({id:e.mongoId});e.databases=l.Databases},E=()=>{e.collections=[],e.collection="",e.dataTabs={},V()},V=async()=>{e.collections=await D.collections.request({id:e.mongoId,database:e.database})},f=()=>{const l=e.collection;if(!e.dataTabs[l]){const a={filter:"{}",sort:'{"_id": -1}',skip:0,limit:12},i={name:l,datas:[],findParamStr:JSON.stringify(a),findParam:a};e.dataTabs[l]=i}e.activeName=l,m(l)},P=l=>{const s=Object.keys(e.dataTabs);for(let a=0;a<s.length;a++)l==s[a]&&o.value[a].blur();e.findDialog.findParam=e.dataTabs[l].findParam,e.findDialog.visible=!0},N=()=>{e.dataTabs[e.activeName].findParam=e.findDialog.findParam,e.dataTabs[e.activeName].findParamStr=JSON.stringify(e.findDialog.findParam),e.findDialog.visible=!1,m(e.activeName)},m=async l=>{const a=e.dataTabs[l].findParam;let i,b;try{i=a.filter?JSON.parse(a.filter):{},b=a.sort?JSON.parse(a.sort):{}}catch{C.error("filter\u6216sort\u5B57\u6BB5json\u5B57\u7B26\u4E32\u503C\u9519\u8BEF\u3002\u6CE8\u610F: json key\u9700\u53CC\u5F15\u53F7");return}const F=await D.findCommand.request({id:e.mongoId,database:e.database,collection:l,filter:i,sort:b,limit:a.limit||12,skip:a.skip||0});e.dataTabs[l].datas=T(F)},T=l=>{const s=[];if(!l)return s;for(let a of l)s.push({value:G(JSON.stringify(a),!1)});return s},p=()=>{const l=e.dataTabs[e.activeName].datas[0];let s="";if(l){const a=JSON.parse(l.value);delete a._id,s=G(JSON.stringify(a),!1)}e.insertDocDialog.doc=s,e.insertDocDialog.visible=!0},g=async()=>{let l;try{l=JSON.parse(e.insertDocDialog.doc)}catch{C.error("\u6587\u6863\u5185\u5BB9\u9519\u8BEF,\u65E0\u6CD5\u89E3\u6790\u4E3Ajson\u5BF9\u8C61")}const s=await D.insertCommand.request({id:e.mongoId,database:e.database,collection:e.activeName,doc:l});U(s.InsertedID,"\u65B0\u589E\u5931\u8D25"),C.success("\u65B0\u589E\u6210\u529F"),m(e.activeName),e.insertDocDialog.visible=!1},I=async l=>{const s=h(l),a=s._id;R(a,"\u6587\u6863\u7684_id\u5C5E\u6027\u4E0D\u5B58\u5728"),delete s._id;const i=await D.updateByIdCommand.request({id:e.mongoId,database:e.database,collection:e.collection,docId:a,update:{$set:s}});U(i.ModifiedCount==1,"\u4FEE\u6539\u5931\u8D25"),C.success("\u4FDD\u5B58\u6210\u529F")},S=async l=>{const a=h(l)._id;R(a,"\u6587\u6863\u7684_id\u5C5E\u6027\u4E0D\u5B58\u5728");const i=await D.deleteByIdCommand.request({id:e.mongoId,database:e.database,collection:e.collection,docId:a});U(i.DeletedCount==1,"\u5220\u9664\u5931\u8D25"),C.success("\u5220\u9664\u6210\u529F"),m(e.activeName)},h=l=>{try{return JSON.parse(l)}catch(s){throw C.error("\u6587\u6863\u5185\u5BB9\u89E3\u6790\u4E3Ajson\u5BF9\u8C61\u5931\u8D25"),s}},j=l=>{const s=l.props.name;e.collection=s},O=l=>{const s=Object.keys(e.dataTabs);let a=e.activeName;s.forEach((i,b)=>{if(i===l){const F=s[b+1]||s[b-1];F&&(a=F)}}),e.activeName=a,a==l?e.collection="":e.collection=a,delete e.dataTabs[l]};return L(A({},te(e)),{findParamInputRef:o,changeProjectEnv:$,changeMongo:q,changeDatabase:E,changeCollection:f,onDataTabClick:j,removeDataTab:O,showFindDialog:P,confirmFindDialog:N,findCommand:m,showInsertDocDialog:p,onInsertDoc:g,onSaveDoc:I,onDeleteDoc:S,formatByteSize:x})}}),ie={class:"toolbar"},ue={style:{float:"left"}},de={style:{float:"right",color:"#8492a6","margin-left":"6px","font-size":"13px"}},re={style:{float:"left"}},me={style:{float:"right",color:"#8492a6","margin-left":"4px","font-size":"13px"}},ce=v("\u67E5\u8BE2\u53C2\u6570"),fe={style:{padding:"3px",float:"right"},class:"mr5 mongo-doc-btns"},pe=v("\u4FDD\u5B58"),be=v("\u5220\u9664"),ge=v("\u53D6 \u6D88"),De=v("\u786E \u5B9A"),ve=v("\u53D6 \u6D88"),_e=v("\u786E \u5B9A"),ye=c("div",{style:{"text-align":"center","margin-top":"10px"}},null,-1);function Ce(o,e,d,$,q,J){const E=u("el-option"),V=u("el-select"),f=u("el-form-item"),P=u("project-env-select"),N=u("el-col"),m=u("el-row"),T=u("el-link"),p=u("el-input"),g=u("el-button"),I=u("el-popconfirm"),S=u("el-card"),h=u("el-tab-pane"),j=u("el-tabs"),O=u("el-container"),l=u("el-form"),s=u("el-dialog");return r(),_("div",null,[c("div",ie,[t(m,{type:"flex",justify:"space-between"},{default:n(()=>[t(N,{span:24},{default:n(()=>[t(P,{onChangeProjectEnv:o.changeProjectEnv},{default:n(()=>[t(f,{label:"\u5B9E\u4F8B","label-width":"40px"},{default:n(()=>[t(V,{modelValue:o.mongoId,"onUpdate:modelValue":e[0]||(e[0]=a=>o.mongoId=a),placeholder:"\u8BF7\u9009\u62E9mongo",onChange:o.changeMongo},{default:n(()=>[(r(!0),_(B,null,k(o.mongoList,a=>(r(),y(E,{key:a.id,label:a.name,value:a.id},{default:n(()=>[c("span",ue,w(a.name),1),c("span",de,w(` [${a.uri}]`),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])]),_:1}),t(f,{label:"\u5E93","label-width":"20px"},{default:n(()=>[t(V,{modelValue:o.database,"onUpdate:modelValue":e[1]||(e[1]=a=>o.database=a),placeholder:"\u8BF7\u9009\u62E9\u5E93",onChange:o.changeDatabase},{default:n(()=>[(r(!0),_(B,null,k(o.databases,a=>(r(),y(E,{key:a.Name,label:a.Name,value:a.Name},{default:n(()=>[c("span",re,w(a.Name),1),c("span",me,w(` [${o.formatByteSize(a.SizeOnDisk)}]`),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])]),_:1}),t(f,{label:"\u96C6\u5408","label-width":"40px"},{default:n(()=>[t(V,{modelValue:o.collection,"onUpdate:modelValue":e[2]||(e[2]=a=>o.collection=a),placeholder:"\u8BF7\u9009\u62E9\u96C6\u5408",onChange:o.changeCollection},{default:n(()=>[(r(!0),_(B,null,k(o.collections,a=>(r(),y(E,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])]),_:1})]),_:1},8,["onChangeProjectEnv"])]),_:1})]),_:1})]),t(O,{id:"data-exec",style:{border:"1px solid #eee","margin-top":"1px"}},{default:n(()=>[t(j,{onTabRemove:o.removeDataTab,onTabClick:o.onDataTabClick,style:{width:"100%","margin-left":"5px"},modelValue:o.activeName,"onUpdate:modelValue":e[4]||(e[4]=a=>o.activeName=a)},{default:n(()=>[(r(!0),_(B,null,k(o.dataTabs,a=>(r(),y(h,{closable:"",key:a.name,label:a.name,name:a.name},{default:n(()=>[o.mongoId?(r(),y(m,{key:0},{default:n(()=>[t(T,{onClick:e[3]||(e[3]=i=>o.findCommand(o.activeName)),icon:"refresh",underline:!1,class:"ml5"}),t(T,{onClick:o.showInsertDocDialog,class:"ml5",type:"primary",icon:"plus",underline:!1},null,8,["onClick"])]),_:1})):ne("",!0),t(m,{class:"mt5 mb5"},{default:n(()=>[t(p,{ref_for:!0,ref:"findParamInputRef",modelValue:a.findParamStr,"onUpdate:modelValue":i=>a.findParamStr=i,placeholder:"\u70B9\u51FB\u8F93\u5165\u76F8\u5E94\u67E5\u8BE2\u6761\u4EF6",onFocus:i=>o.showFindDialog(a.name)},{prepend:n(()=>[ce]),_:2},1032,["modelValue","onUpdate:modelValue","onFocus"])]),_:2},1024),t(m,null,{default:n(()=>[(r(!0),_(B,null,k(a.datas,i=>(r(),y(N,{span:6,key:i},{default:n(()=>[t(S,{"body-style":{padding:"0px",position:"relative"}},{default:n(()=>[t(p,{type:"textarea",modelValue:i.value,"onUpdate:modelValue":b=>i.value=b,rows:12},null,8,["modelValue","onUpdate:modelValue"]),c("div",fe,[c("div",null,[t(g,{onClick:b=>o.onSaveDoc(i.value),type:"warning",plain:"",size:"small"},{default:n(()=>[pe]),_:2},1032,["onClick"]),t(I,{onConfirm:b=>o.onDeleteDoc(i.value),title:"\u786E\u5B9A\u5220\u9664\u8BE5\u6587\u6863?"},{reference:n(()=>[t(g,{type:"danger",plain:"",size:"small"},{default:n(()=>[be]),_:1})]),_:2},1032,["onConfirm"])])])]),_:2},1024)]),_:2},1024))),128))]),_:2},1024)]),_:2},1032,["label","name"]))),128))]),_:1},8,["onTabRemove","onTabClick","modelValue"])]),_:1}),t(s,{width:"400px",title:"find\u53C2\u6570",modelValue:o.findDialog.visible,"onUpdate:modelValue":e[10]||(e[10]=a=>o.findDialog.visible=a)},{footer:n(()=>[c("div",null,[t(g,{onClick:e[9]||(e[9]=a=>o.findDialog.visible=!1)},{default:n(()=>[ge]),_:1}),t(g,{onClick:o.confirmFindDialog,type:"primary"},{default:n(()=>[De]),_:1},8,["onClick"])])]),default:n(()=>[t(l,{"label-width":"70px"},{default:n(()=>[t(f,{label:"filter"},{default:n(()=>[t(p,{modelValue:o.findDialog.findParam.filter,"onUpdate:modelValue":e[5]||(e[5]=a=>o.findDialog.findParam.filter=a),type:"textarea",rows:6,clearable:"","auto-complete":"off"},null,8,["modelValue"])]),_:1}),t(f,{label:"sort"},{default:n(()=>[t(p,{modelValue:o.findDialog.findParam.sort,"onUpdate:modelValue":e[6]||(e[6]=a=>o.findDialog.findParam.sort=a),type:"textarea",rows:3,clearable:"","auto-complete":"off"},null,8,["modelValue"])]),_:1}),t(f,{label:"limit"},{default:n(()=>[t(p,{modelValue:o.findDialog.findParam.limit,"onUpdate:modelValue":e[7]||(e[7]=a=>o.findDialog.findParam.limit=a),modelModifiers:{number:!0},type:"number","auto-complete":"off"},null,8,["modelValue"])]),_:1}),t(f,{label:"skip"},{default:n(()=>[t(p,{modelValue:o.findDialog.findParam.skip,"onUpdate:modelValue":e[8]||(e[8]=a=>o.findDialog.findParam.skip=a),modelModifiers:{number:!0},type:"number","auto-complete":"off"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(s,{width:"600px",title:`\u65B0\u589E'${o.activeName}'\u96C6\u5408\u6587\u6863`,modelValue:o.insertDocDialog.visible,"onUpdate:modelValue":e[13]||(e[13]=a=>o.insertDocDialog.visible=a),"close-on-click-modal":!1},{footer:n(()=>[c("div",null,[t(g,{onClick:e[12]||(e[12]=a=>o.insertDocDialog.visible=!1)},{default:n(()=>[ve]),_:1}),t(g,{onClick:o.onInsertDoc,type:"primary"},{default:n(()=>[_e]),_:1},8,["onClick"])])]),default:n(()=>[t(p,{modelValue:o.insertDocDialog.doc,"onUpdate:modelValue":e[11]||(e[11]=a=>o.insertDocDialog.doc=a),type:"textarea",rows:12,clearable:"","auto-complete":"off"},null,8,["modelValue"])]),_:1},8,["title","modelValue"]),ye])}var Pe=ee(se,[["render",Ce]]);export{Pe as default};
